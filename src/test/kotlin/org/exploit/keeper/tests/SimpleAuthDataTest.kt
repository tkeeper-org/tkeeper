package org.exploit.keeper.tests

import org.exploit.keeper.model.auth.SimpleAuthData
import org.junit.jupiter.api.Nested
import kotlin.test.Test
import kotlin.test.assertFalse
import kotlin.test.assertTrue

class SimpleAuthDataTest {

    @Nested
    inner class AllowDeny {
        @Test
        fun `allow wildcard then deny specific key blocks that key`() {
            val auth = SimpleAuthData(
                subject = "service-a",
                permissions = listOf(
                    "tkeeper.key.*.sign",
                    "-tkeeper.key.master-root.sign"
                )
            )

            assertTrue(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
            assertFalse(auth.hasPermission("tkeeper.key.master-root.sign"))
        }

        @Test
        fun `deny prefix wildcard blocks entire group`() {
            val auth = SimpleAuthData(
                subject = "service-b",
                permissions = listOf(
                    "tkeeper.key.*.sign",
                    "-tkeeper.key.master-*.sign"
                )
            )

            assertTrue(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
            assertFalse(auth.hasPermission("tkeeper.key.master-root.sign"))
            assertFalse(auth.hasPermission("tkeeper.key.master-backup.sign"))
        }

        @Test
        fun `no permissions means everything denied`() {
            val auth = SimpleAuthData(subject = "empty-service")
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
        }

        @Test
        fun `exact permission grants only that permission`() {
            val auth = SimpleAuthData(
                subject = "narrow-service",
                permissions = listOf("tkeeper.key.wallet-hot.sign")
            )

            assertTrue(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.decrypt"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-cold.sign"))
        }

        @Test
        fun `deny without matching allow still denies`() {
            val auth = SimpleAuthData(
                subject = "only-deny",
                permissions = listOf("-tkeeper.key.*.destroy")
            )

            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.destroy"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
        }
    }

    @Nested
    inner class CustodyScenarios {
        @Test
        fun `hot wallet service can sign but not destroy`() {
            val auth = SimpleAuthData(
                subject = "hot-wallet-svc",
                permissions = listOf(
                    "tkeeper.key.wallet-*.sign",
                    "tkeeper.key.wallet-*.public",
                    "-tkeeper.key.*.destroy"
                )
            )

            assertTrue(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
            assertTrue(auth.hasPermission("tkeeper.key.wallet-cold.public"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.destroy"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.decrypt"))
        }

        @Test
        fun `auditor has only read permissions`() {
            val auth = SimpleAuthData(
                subject = "auditor",
                permissions = listOf(
                    "tkeeper.key.*.public",
                    "tkeeper.key.*.verify",
                    "tkeeper.audit.log.verify",
                    "tkeeper.compliance.inventory"
                )
            )

            assertTrue(auth.hasPermission("tkeeper.key.master-root.public"))
            assertTrue(auth.hasPermission("tkeeper.key.wallet-hot.verify"))
            assertTrue(auth.hasPermission("tkeeper.audit.log.verify"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.sign"))
            assertFalse(auth.hasPermission("tkeeper.key.wallet-hot.destroy"))
        }
    }
}